<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Live TV Pro</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

  :root {
    --bg-primary: #0a0a0a;
    --bg-secondary: #1a1a1a;
    --bg-tertiary: #1f1f1f;
    --text-primary: #e0e0e0;
    --text-secondary: #ccc;
    --accent: #e74c3c;
    --accent-hover: #f40612;
    --progress-color: #ff0000;
    --font-size-base: 16px;
    --card-border-radius: 12px;
    --player-border-radius: 0;
    --control-size: 20px;
    --grid-columns: minmax(180px,1fr);
    --player-aspect: 16/9;
    --bg-image: none;
    --progress-height: 5px;
    --buffered-color: rgba(255,255,255,0.4);
    --search-radius: 24px;
    --search-border: #2a2a2a;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --live-indicator: #e74c3c;
    --channel-number-bg: rgba(0,0,0,0.7);
    --channel-number-color: #fff;
    --channel-number-size: 14px;
    --channel-number-padding: 4px 8px;
    --channel-number-radius: 4px;
    --epg-now-color: #e74c3c;
    --epg-next-color: #3498db;
  }

  .light-theme {
    --bg-primary: #f0f0f0;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f5f5f5;
    --text-primary: #333;
    --text-secondary: #666;
    --accent: #c0392b;
    --accent-hover: #a93226;
    --progress-color: #ff4444;
    --buffered-color: rgba(0,0,0,0.4);
    --search-border: #cccccc;
  }

  .blue-theme {
    --bg-primary: #0a192f;
    --bg-secondary: #1a365d;
    --bg-tertiary: #102542;
    --text-primary: #e6f1ff;
    --text-secondary: #a0d1ff;
    --accent: #3182ce;
    --accent-hover: #2b6cb0;
    --progress-color: #63b3ed;
  }

  .green-theme {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #162032;
    --text-primary: #d1fae5;
    --text-secondary: #a7f3d0;
    --accent: #10b981;
    --accent-hover: #059669;
    --progress-color: #34d399;
  }

  * {box-sizing: border-box;}
  body {margin:0;font-family:'Inter', -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);padding-top:60px;padding-bottom:70px;font-size:var(--font-size-base);background-image:var(--bg-image);background-size:cover;background-position:center;}
  body.fullscreen-mode {overflow:hidden;padding-top:0;padding-bottom:0;}
  body.fullscreen-mode header,
  body.fullscreen-mode .search-bar,
  body.fullscreen-mode .grid,
  body.fullscreen-mode .stream-info,
  body.fullscreen-mode .stream-player-container > div:first-child,
  body.fullscreen-mode .sidebar,
  body.fullscreen-mode .bottom-nav {display:none!important;}
  body.fullscreen-mode .content {padding:0!important;max-width:100%!important;height:100vh!important;display:flex!important;align-items:center!important;justify-content:center!important;}
  body.fullscreen-mode .sticky-player-container {position:fixed!important;top:0!important;left:0!important;right:0!important;bottom:0!important;margin:0!important;}
  body.fullscreen-mode .video-player {max-width:100%!important;width:100%!important;border-radius:0!important;height:100vh!important;margin:0!important;}
  body.fullscreen-mode video {height:100vh!important;object-fit:contain!important;}
  
  header {background:var(--bg-secondary);padding:12px 16px;display:flex;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.3);position:fixed;top:0;left:0;right:0;z-index:1000;}
  .menu-btn {font-size:24px;cursor:pointer;margin-right:16px;color:var(--text-primary);transition:transform 0.2s;}
  .menu-btn:hover {transform:scale(1.1);}
  .title {font-size:20px;font-weight:600;color:var(--text-primary);display:flex;align-items:center;}
  
  .logo-icon {
    width: 32px;
    height: 32px;
    margin-right: 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    border-radius: 6px;
    color: white;
    font-weight: 700;
  }
  
  .logo-icon svg {
    width: 24px;
    height: 24px;
    fill: white;
  }
  
  /* Sidebar */
  .sidebar{height:100%;width:0;position:fixed;top:0;left:0;background:var(--bg-secondary);overflow-x:hidden;transition:0.3s ease;padding-top:60px;z-index:2000;box-shadow:2px 0 10px rgba(0,0,0,0.5);}
  .sidebar a{padding:14px 24px;display:flex;align-items:center;font-size:16px;color:var(--text-primary);text-decoration:none;transition:all 0.2s;}
  .sidebar a:hover{background:#2a2a2a;padding-left:30px;}
  .sidebar svg{margin-right:16px;width:24px;height:24px;fill:var(--text-primary);}
  .closebtn{position:absolute;top:12px;right:20px;font-size:32px;cursor:pointer;color:var(--text-primary);}
  .closebtn:hover{color:#ff4444;}
  
  /* Content */
  .content{padding:12px;max-width:100%;margin:0 auto;}
  
  /* Sticky Player Container */
  .sticky-player-container{position:sticky;top:60px;z-index:900;margin-bottom:20px;}
  
  /* Custom Video Player */
  .video-player{position:relative;background:#000;border-radius:var(--player-border-radius);overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.5);max-width:900px;margin:0 auto;aspect-ratio:var(--player-aspect);}
  .video-wrapper{position:relative;width:100%;height:100%;background:#000;}
  video{width:100%;height:100%;display:block;background:#000;object-fit:contain;}
  
  /* Custom Controls */
  .custom-controls{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,0.9),transparent);padding:20px 15px 15px;opacity:0;transition:opacity 0.3s;z-index:10;}
  .video-player.show-controls .custom-controls{opacity:1;}
  
  /* Progress Container - Enhanced Seekbar */
  .progress-container {
    width: 100%;
    height: var(--progress-height);
    background: rgba(255,255,255,0.2);
    cursor: pointer;
    margin-bottom: 15px;
    position: relative;
    transition: height 0.2s;
    border-radius: 2px;
  }
  .progress-container:hover {
    height: calc(var(--progress-height) + 2px);
  }
  .progress-buffered {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: var(--buffered-color);
    z-index: 1;
  }
  .progress-bar {
    height: 100%;
    background: var(--progress-color);
    position: relative;
    z-index: 2;
    transition: width 0.1s;
  }
  .progress-bar::after {
    content: '';
    position: absolute;
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    background: var(--progress-color);
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .progress-container:hover .progress-bar::after {
    opacity: 1;
  }
  .progress-preview {
    position: absolute;
    bottom: 20px;
    background: rgba(0,0,0,0.9);
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    display: none;
    pointer-events: none;
    transform: translateX(-50%);
  }
  
  /* Control Buttons */
  .controls-bottom{display:flex;align-items:center;justify-content:space-between;}
  .controls-left, .controls-right{display:flex;align-items:center;gap:10px;}
  
  .control-button{background:none;border:none;color:var(--text-primary);cursor:pointer;padding:5px;transition:transform 0.2s;display:flex;align-items:center;justify-content:center;}
  .control-button:hover{transform:scale(1.1);}
  .control-button svg{width:var(--control-size);height:var(--control-size);fill:var(--text-primary);}
  .control-button:disabled{opacity:0.5;cursor:not-allowed;}
  
  /* Time Display */
  .time-display{color:var(--text-primary);font-size:13px;margin:0 10px;}
  
  /* Center Play Button */
  .center-controls{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:5;pointer-events:none;}
  .center-play-btn{width:70px;height:70px;background:rgba(0,0,0,0.7);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:all 0.3s;backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,0.2);pointer-events:auto;}
  .video-player.show-controls .center-play-btn{opacity:0.8;}
  .center-play-btn:hover{transform:scale(1.1);opacity:1!important;}
  .center-play-btn svg{width:35px;height:35px;fill:var(--text-primary);margin-left:3px;}
  .video-player.playing .center-play-btn{opacity:0!important;}
  .video-player.paused .center-play-btn{opacity:1!important;}
  
  /* Top Controls */
  .top-controls{position:absolute;top:0;left:0;right:0;background:linear-gradient(to bottom,rgba(0,0,0,0.9),transparent);padding:15px;opacity:0;transition:opacity 0.3s;display:flex;justify-content:space-between;align-items:center;}
  .video-player.show-controls .top-controls{opacity:1;}
  
  /* Quality Menu */
  .quality-menu{display:none;position:absolute;bottom:60px;right:15px;background:rgba(20,20,20,0.95);border-radius:8px;min-width:120px;max-height:300px;overflow-y:auto;z-index:20;box-shadow:0 4px 20px rgba(0,0,0,0.5);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);}
  .quality-menu-header{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600;font-size:13px;color:var(--accent);position:sticky;top:0;background:rgba(20,20,20,0.95);z-index:1;}
  .quality-option{padding:10px 14px;cursor:pointer;transition:background 0.2s;display:flex;justify-content:space-between;align-items:center;font-size:13px;}
  .quality-option:hover{background:rgba(255,255,255,0.1);}
  .quality-option.active{background:rgba(52,152,219,0.2);color:var(--accent);}
  .quality-option.active::after{content:'✓';margin-left:8px;font-size:12px;}
  
  /* Player Loading Indicator */
  .player-loading-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);padding:20px;border-radius:8px;display:none;z-index:14;text-align:center;width:200px;}
  .player-loading-indicator.show{display:block;}
  .loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .loading-text{color:#fff;font-size:14px;}
  
  /* Fullscreen Styles */
  .video-player:fullscreen{max-width:100%;border-radius:0;}
  .video-player:fullscreen video{height:100vh;object-fit:contain;}
  
  /* Channel Grid */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,var(--grid-columns));gap:12px;margin-top:20px;}
  .card {
    background: var(--bg-secondary);
    border-radius: var(--card-border-radius);
    overflow: hidden;
    transition: all var(--transition-normal);
    cursor: pointer;
    border: 1px solid transparent;
    position: relative;
    margin-bottom: 8px;
  }
  .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg);border-color:#333;}
  
  .thumbnail-container {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    background: var(--bg-tertiary);
    overflow: hidden;
  }
  
  .thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px 8px 0 0;
    margin-bottom: 0;
    position: absolute;
    top: 0;
    left: 0;
  }
  
  .play-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity var(--transition-normal);
  }
  
  .card:hover .play-overlay {
    opacity: 1;
  }
  
  .play-overlay-btn {
    width: 50px;
    height: 50px;
    background: var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .play-overlay-btn svg {
    width: 24px;
    height: 24px;
    fill: white;
    margin-left: 3px;
  }
  
  .card-content {
    padding: 12px;
  }
  
  .channel-name{font-weight:500;margin:8px 0 4px;font-size:14px;line-height:1.3;height:2.6em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
  .channel-category{font-size:12px;color:var(--text-secondary);margin-bottom:8px;}
  .btn-group{display:flex;justify-content:center;gap:8px;margin-top:8px;}
  button{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s;}
  button:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,0.3);}
  .play-btn{background:var(--accent);color:#fff;}
  .play-btn:hover{background:var(--accent-hover);}
  .copy-btn{background:#3498db;color:#fff;}
  .copy-btn:hover{background:#2980b9;}
  .add-fav-btn{background:#f39c12;color:#fff;}
  .add-fav-btn:hover{background:#e67e22;}
  .fav-btn{background:#f1c40f;color:#000;}
  .fav-btn:hover{background:#f39c12;}
  
  /* Channel Number Badge */
  .channel-number {
    position: absolute;
    top: 8px;
    left: 8px;
    background: var(--channel-number-bg);
    color: var(--channel-number-color);
    font-size: var(--channel-number-size);
    padding: var(--channel-number-padding);
    border-radius: var(--channel-number-radius);
    z-index: 5;
    font-weight: 600;
  }
  
  /* Live Indicator */
  .live-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    background: var(--live-indicator);
    color: white;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    z-index: 5;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  
  .live-indicator::before {
    content: "";
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  /* Updated Search Bar */
  .search-bar {
    position: sticky;
    top: 60px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--bg-secondary);
    border-radius: var(--search-radius);
    border: 2px solid var(--search-border);
    margin: 20px 0;
    z-index: 100;
  }

  .search-button {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
    color: var(--text-primary);
  }

  .search-input {
    flex: 1;
    padding: 8px 10px;
    border: none;
    background: transparent;
    color: var(--text-primary);
    font-size: 16px;
    min-width: 0;
  }

  .search-input:focus {
    outline: none;
  }

  .search-input::placeholder {
    color: #999;
  }
  
  .clear-button {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
    color: var(--text-primary);
    display: none; /* Hidden by default */
  }
  
  .search-input:not(:placeholder-shown) + .clear-button {
    display: flex; /* Show when input has content */
  }
  
  /* Playlist */
  .playlist-list{margin-top:20px;}
  .playlist-item{background:var(--bg-secondary);margin:8px 0;padding:16px;display:flex;justify-content:space-between;align-items:center;border-radius:8px;transition:all 0.2s;}
  .playlist-item:hover{background:#2a2a2a;}
  .playlist-name{font-size:16px;font-weight:500;}
  .playlist-url{font-size:12px;color:var(--text-secondary);margin-top:4px;word-break:break-all;}
  .playlist-actions{display:flex;gap:8px;}
  .playlist-actions button{padding:6px 12px;font-size:13px;}
  
  /* FAB */
  .fab{position:fixed;bottom:90px;right:24px;background:var(--accent);color:#fff;border-radius:50%;width:56px;height:56px;font-size:28px;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:all 0.3s;z-index:999;}
  .fab:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(0,0,0,0.4);}
  .fab-menu{position:fixed;bottom:150px;right:24px;background:var(--bg-secondary);border-radius:12px;display:none;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,0.5);overflow:hidden;z-index:999;}
  .fab-menu button, .fab-menu label{background:var(--bg-secondary);color:var(--text-primary);border:none;padding:14px 20px;text-align:left;cursor:pointer;transition:background 0.2s;}
  .fab-menu button:hover, .fab-menu label:hover{background:#2a2a2a;}
  
  /* Forms */
  .form-input{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:2px solid #2a2a2a;background:var(--bg-secondary);color:var(--text-primary);font-size:16px;}
  .form-input:focus{outline:none;border-color:var(--accent);}
  .load-btn{background:var(--accent);color:#fff;padding:10px 24px;margin-left:8px;}
  .load-btn:hover{background:var(--accent-hover);}
  
  /* Stream Info */
  .stream-info{background:var(--bg-secondary);border-radius:8px;padding:16px;margin-top:16px;}
  .stream-info h3{margin:0 0 8px 0;color:var(--accent);}
  .stream-info p{margin:4px 0;color:var(--text-secondary);font-size:14px;}
  
  /* Loading */
  .loading{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);padding:20px 40px;border-radius:8px;z-index:3000;}
  .loading::after{content:'Loading...';color:#fff;font-size:18px;}
  
  /* Toast */
  .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:24px;display:none;z-index:3000;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
  
  /* Empty State */
  .empty-state{text-align:center;padding:60px 20px;color:#999;}
  .empty-state h3{font-size:24px;margin-bottom:10px;}
  
  /* Modal */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:3000;align-items:center;justify-content:center;}
  .modal-content{background:var(--bg-secondary);padding:24px;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
  .modal-header h3{margin:0;color:var(--text-primary);}
  .modal-close{background:none;border:none;color:var(--text-primary);font-size:24px;cursor:pointer;}
  .modal-close:hover{color:#ff4444;}
  .modal-body input{width:100%;margin-bottom:12px;}
  .modal-footer{display:flex;justify-content:flex-end;gap:12px;margin-top:20px;}
  
  /* Scrollbar Styling */
  .quality-menu::-webkit-scrollbar{width:6px;}
  .quality-menu::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);}
  .quality-menu::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:3px;}
  .quality-menu::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.3);}
  
  /* Bottom Navigation */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-secondary);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
    z-index: 1000;
  }
  
  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 12px;
    transition: color 0.2s;
    flex: 1;
    padding: 8px 0;
  }
  
  .nav-item.active {
    color: var(--accent);
  }
  
  .nav-icon {
    width: 24px;
    height: 24px;
    margin-bottom: 4px;
    fill: currentColor;
  }
  
  /* Homepage Categories */
  .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px;
    margin-top: 20px;
  }
  
  .category-card {
    background: var(--bg-secondary);
    border-radius: 10px;
    text-align: center;
    padding: 12px 8px;
    cursor: pointer;
    transition: transform 0.25s, box-shadow 0.25s;
    border: 1px solid transparent;
  }
  
  .category-card:hover {
    border-color: var(--accent);
    transform: scale(1.05);
    box-shadow: var(--shadow-lg);
  }
  
  .category-card img {
    width: 48px;
    height: 48px;
    object-fit: contain;
    border-radius: 50%;
    border: 2px solid var(--accent);
    margin-bottom: 8px;
  }
  
  .category-card span {
    display: block;
    font-weight: 500;
    font-size: 13px;
    margin-top: 6px;
  }
  
  /* Hide search bar by default */
  .search-bar {
    display: none;
  }
  
  /* Show search bar only on playlist pages */
  .playlist-page .search-bar {
    display: flex;
  }
  
  /* Light mode player controls */
  .light-theme .custom-controls {
    background: linear-gradient(to top, rgba(255,255,255,0.9), transparent);
  }
  
  .light-theme .top-controls {
    background: linear-gradient(to bottom, rgba(255,255,255,0.9), transparent);
  }
  
  .light-theme .progress-container {
    background: rgba(0,0,0,0.2);
  }
  
  .light-theme .progress-buffered {
    background: rgba(0,0,0,0.4);
  }
  
  .light-theme .control-button {
    color: #333;
  }
  
  .light-theme .control-button svg {
    fill: #333;
  }
  
  .light-theme .time-display {
    color: #333;
  }
  
  .light-theme .center-play-btn {
    background: rgba(255,255,255,0.7);
    border: 2px solid rgba(0,0,0,0.2);
  }
  
  .light-theme .center-play-btn svg {
    fill: #333;
  }
  
  .light-theme .quality-menu {
    background: rgba(240,240,240,0.95);
    border: 1px solid rgba(0,0,0,0.1);
  }
  
  .light-theme .quality-menu-header {
    background: rgba(240,240,240,0.95);
    border-bottom: 1px solid rgba(0,0,0,0.1);
    color: #c0392b;
  }
  
  .light-theme .quality-option:hover {
    background: rgba(0,0,0,0.1);
  }
  
  .light-theme .quality-option.active {
    background: rgba(52,152,219,0.2);
    color: #c0392b;
  }
  
  .light-theme .progress-preview {
    background: rgba(0,0,0,0.9);
    color: #fff;
  }
  
  .light-theme .player-title {
    color: #333;
  }
  
  /* Responsive */
  @media (max-width:768px){
    .grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;}
    .content{padding:10px;}
    .search-input{font-size:14px;}
    .sticky-player-container{top:50px;}
    .channel-name{font-size:13px;}
    .channel-category{font-size:11px;}
    .btn-group button{padding:6px 12px;font-size:12px;}
    
    .category-grid {
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 10px;
    }
    
    .category-card {
      padding: 10px 6px;
    }
    
    .category-card img {
      width: 40px;
      height: 40px;
    }
    
    .category-card span {
      font-size: 12px;
    }
    
    #streamUrl {
      font-size: 14px;
    }
  }
  
  @media (max-width:480px){
    .grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;}
    .card{padding:10px;}
    .thumbnail{height:80px;}
    .channel-name{font-size:12px;margin:6px 0 3px;}
    .btn-group{gap:6px;margin-top:6px;}
    .btn-group button{padding:5px 10px;font-size:11px;}
    
    .category-grid {
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 8px;
    }
    
    .category-card {
      padding: 8px 4px;
    }
    
    .category-card img {
      width: 36px;
      height: 36px;
    }
    
    .category-card span {
      font-size: 11px;
    }
    
    #streamUrl {
      font-size: 13px;
    }
  }
</style>
</head>
<body>
<header>
  <span class="menu-btn" onclick="toggleSidebar(true)" aria-label="Open menu">☰</span>
  <div style="display: flex; align-items: center;">
    <span class="logo-icon">
      <svg viewBox="0 0 24 24">
        <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 10H3V8h18v8z"/>
        <path d="M9 11l3 3 3-3"/>
      </svg>
    </span>
    <span class="title">Live TV Pro</span>
  </div>
</header>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar" role="navigation">
  <span class="closebtn" onclick="toggleSidebar(false)" aria-label="Close menu">×</span>
  <a href="#" onclick="navigateTo('homepage'); return false;" tabindex="0">
    <svg viewBox="0 0 24 24">
      <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
    <span>Home</span>
  </a>
  <a href="#" onclick="navigateTo('networkStreamPage'); return false;" tabindex="0">
    <svg viewBox="0 0 24 24">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
    </svg>
    <span>Direct Stream</span>
  </a>
  <a href="#" onclick="navigateTo('playlistPage'); return false;" tabindex="0">
    <svg viewBox="0 0 24 24">
      <path d="M19 9H2v2h17V9zm0-4H2v2h17V5zm0 8H2v2h17v-2zm0 4H2v2h17v-2zM2 3v2h17V3H2z"/>
    </svg>
    <span>My Playlists</span>
  </a>
  <a href="#" onclick="navigateTo('favoritesPage'); return false;" tabindex="0">
    <svg viewBox="0 0 24 24">
      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
    </svg>
    <span>Favorites</span>
  </a>
  <a href="#" onclick="openSettingsModal(); return false;" tabindex="0">
    <svg viewBox="0 0 24 24">
      <path d="M19.14,12.94c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
    </svg>
    <span>Settings</span>
  </a>
</div>

<div class="content">

  <!-- HOMEPAGE -->
  <div id="homepage" class="page" style="display:block;">
    <h2>📺 Categories</h2>
    <div id="categoryGrid" class="category-grid"></div>
  </div>

  <!-- NETWORK STREAM -->
  <div id="networkStreamPage" class="page" style="display:none;">
    <h2>🌐 Direct Stream Player</h2>
    <p style="color:var(--text-secondary);margin-bottom:20px;">Play a direct stream URL (m3u8, mp4, etc.)</p>
    
    <div class="sticky-player-container">
      <div class="video-player" id="directPlayer" style="display:none;">
        <div class="video-wrapper">
          <video id="directVideo" tabindex="0"></video>
          <div class="player-loading-indicator" id="directPlayerLoading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading stream...</div>
          </div>
          
          <!-- Center Play Button -->
          <div class="center-controls">
            <div class="center-play-btn" onclick="togglePlayPause('direct')" tabindex="0" role="button" aria-label="Play/Pause">
              <svg viewBox="0 0 24 24" id="directCenterIcon">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </div>
          </div>
          
          <!-- Top Controls -->
          <div class="top-controls">
            <div>
              <div class="player-title" id="directTitle">Direct Stream</div>
            </div>
            <div class="live-indicator">LIVE</div>
          </div>
          
          <!-- Custom Controls -->
          <div class="custom-controls" id="directControls">
            <div class="progress-container" id="directProgressContainer" role="slider" aria-label="Seek bar">
              <div class="progress-buffered" id="directProgressBuffered"></div>
              <div class="progress-bar" id="directProgress"></div>
              <div class="progress-preview" id="directProgressPreview"></div>
            </div>
            
            <div class="controls-bottom">
              <div class="controls-left">
                <button class="control-button" onclick="togglePlayPause('direct')" aria-label="Play/Pause">
                  <svg viewBox="0 0 24 24" id="directPlayIcon">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </button>
                
                <button class="control-button" onclick="toggleMute('direct')" aria-label="Mute/Unmute">
                  <svg viewBox="0 0 24 24" id="directVolumeIcon">
                    <!-- Unmuted icon -->
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                  </svg>
                </button>
                
                <div class="time-display">
                  <span id="directCurrentTime">0:00</span> / <span id="directDuration">0:00</span>
                </div>
              </div>
              
              <div class="controls-right">
                <button class="control-button" onclick="toggleQualityMenu('direct')" title="Quality" aria-label="Quality settings">
                  <svg viewBox="0 0 24 24">
                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
                  </svg>
                </button>
                
                <button class="control-button" onclick="togglePiP('direct')" title="Picture in Picture" aria-label="Picture in Picture">
                  <svg viewBox="0 0 24 24">
                    <path d="M19 11h-8v6h8v-6m4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2m-2 .02H3V4.97h18v14.05Z"/>
                  </svg>
                </button>
                
                <button class="control-button" onclick="rotateScreen()" title="Rotate" aria-label="Rotate screen">
                  <svg viewBox="0 0 24 24">
                    <path d="M7.34 6.41L.86 12.9l6.49 6.48 6.49-6.48-6.5-6.49zM3.69 12.9l3.66-3.66L11 12.9l-3.66 3.66-3.65-3.66zm15.67-6.26C17.61 4.88 15.3 4 13 4V.76L8.76 5 13 9.24V6c1.79 0 3.58.68 4.95 2.05 2.73 2.73 2.73 7.17 0 9.9C16.58 19.32 14.79 20 13 20c-.97 0-1.94-.21-2.84-.61l-1.49 1.49C10.02 21.62 11.51 22 13 22c2.3 0 4.61-.88 6.36-2.64 3.52-3.51 3.52-9.21 0-12.72z"/>
                  </svg>
                </button>
                
                <button class="control-button" onclick="toggleFullscreen('direct')" title="Fullscreen" aria-label="Fullscreen" id="directFullscreenBtn">
                  <svg viewBox="0 0 24 24" id="directFullscreenIcon">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Quality Menu -->
          <div class="quality-menu" id="directQualityMenu"></div>
        </div>
      </div>
    </div>
    
    <div class="stream-player-container">
      <div style="display:flex;align-items:center;margin-bottom:20px;max-width:900px;margin:20px auto 20px;">
        <input type="text" id="streamUrl" class="form-input" placeholder="https://example.com/stream.m3u8" style="margin:0;" aria-label="Stream URL">
        <button class="load-btn" onclick="playDirectStream()" aria-label="Play stream">▶ Play</button>
      </div>
    </div>
    
    <div class="stream-info" id="streamInfo" style="display:none;">
      <h3>Stream Information</h3>
      <p id="streamUrlInfo"></p>
      <p id="streamStatus"></p>
      <p id="streamQuality"></p>
    </div>
  </div>

  <!-- PLAYLIST MANAGER -->
  <div id="playlistPage" class="page" style="display:none;">
    <h2>📂 My Playlists</h2>
    <div id="playlistList" class="playlist-list"></div>
    <div id="emptyPlaylist" class="empty-state" style="display:none;">
      <h3>No playlists yet</h3>
      <p>Add your first playlist using the + button below</p>
    </div>
    <button class="fab" onclick="toggleFabMenu()" aria-label="Add playlist">+</button>
    <div id="fabMenu" class="fab-menu">
      <button onclick="addPlaylistUrl()" aria-label="Add playlist via URL">🔗 Add via URL</button>
      <label style="cursor:pointer;margin:0;">
        <span style="padding:14px 20px;display:block;" aria-label="Add playlist via file">📁 Add via File</span>
        <input type="file" accept=".m3u,.m3u8" style="display:none;" onchange="addPlaylistFile(event)" aria-label="Select playlist file">
      </label>
      <button onclick="exportPlaylists()" aria-label="Export playlists">💾 Export Playlists</button>
      <button onclick="importPlaylists()" aria-label="Import playlists">📥 Import Playlists</button>
    </div>
  </div>

  <!-- FAVORITES PAGE -->
  <div id="favoritesPage" class="page" style="display:none;">
    <h2>⭐ Favorite Channels</h2>
    <div id="favoritesGrid" class="grid"></div>
    <div id="emptyFavorites" class="empty-state" style="display:none;">
      <h3>No favorite channels</h3>
      <p>Add channels to favorites by clicking the star icon</p>
    </div>
  </div>

  <!-- PLAYLIST PLAYER -->
  <div id="playlistPlayerPage" class="page playlist-page" style="display:none;">
    <div class="sticky-player-container">
      <div class="video-player" id="playlistPlayer" style="display:none;">
        <div class="video-wrapper">
          <video id="playlistVideo" tabindex="0"></video>
          <div class="player-loading-indicator" id="playlistPlayerLoading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading stream...</div>
          </div>
          
          <!-- Center Play Button -->
          <div class="center-controls">
            <div class="center-play-btn" onclick="togglePlayPause('playlist')" tabindex="0" role="button" aria-label="Play/Pause">
              <svg viewBox="0 0 24 24" id="playlistCenterIcon">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </div>
          </div>
          
          <!-- Top Controls -->
          <div class="top-controls">
            <div>
              <div class="player-title" id="playlistTitle">Channel</div>
            </div>
            <div class="live-indicator">LIVE</div>
          </div>
          
          <!-- Custom Controls -->
          <div class="custom-controls" id="playlistControls">
            <div class="progress-container" id="playlistProgressContainer" role="slider" aria-label="Seek bar">
              <div class="progress-buffered" id="playlistProgressBuffered"></div>
              <div class="progress-bar" id="playlistProgress"></div>
              <div class="progress-preview" id="playlistProgressPreview"></div>
            </div>
            
            <div class="controls-bottom">
              <div class="controls-left">
                <button class="control-button" onclick="togglePlayPause('playlist')" aria-label="Play/Pause">
                  <svg viewBox="0 0 24 24" id="playlistPlayIcon">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </button>
                
                <button class="control-button" onclick="toggleMute('playlist')" aria-label="Mute/Unmute">
                  <svg viewBox="0 0 24 24" id="playlistVolumeIcon">
                    <!-- Unmuted icon -->
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                  </svg>
                </button>
                
                <div class="time-display">
                  <span id="playlistCurrentTime">0:00</span> / <span id="playlistDuration">0:00</span>
                </div>
              </div>
              
              <div class="controls-right">
                <button class="control-button" onclick="toggleQualityMenu('playlist')" title="Quality" aria-label="Quality settings">
                  <svg viewBox="0 0 24 24">
                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
                  </svg>
                </button>
                
                <button class="control-button" onclick="togglePiP('playlist')" title="Picture in Picture" aria-label="Picture in Picture">
                  <svg viewBox="0 0 24 24">
                    <path d="M19 11h-8v6h8v-6m4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2m-2 .02H3V4.97h18v14.05Z"/>
                  </svg>
                </button>
                
                <button class="control-button" onclick="rotateScreen()" title="Rotate" aria-label="Rotate screen">
                  <svg viewBox="0 0 24 24">
                    <path d="M7.34 6.41L.86 12.9l6.49 6.48 6.49-6.48-6.5-6.49zM3.69 12.9l3.66-3.66L11 12.9l-3.66 3.66-3.65-3.66zm15.67-6.26C17.61 4.88 15.3 4 13 4V.76L8.76 5 13 9.24V6c1.79 0 3.58.68 4.95 2.05 2.73 2.73 2.73 7.17 0 9.9C16.58 19.32 14.79 20 13 20c-.97 0-1.94-.21-2.84-.61l-1.49 1.49C10.02 21.62 11.51 22 13 22c2.3 0 4.61-.88 6.36-2.64 3.52-3.51 3.52-9.21 0-12.72z"/>
                  </svg>
                </button>
                
                <button class="control-button" onclick="toggleFullscreen('playlist')" title="Fullscreen" aria-label="Fullscreen" id="playlistFullscreenBtn">
                  <svg viewBox="0 0 24 24" id="playlistFullscreenIcon">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Quality Menu -->
          <div class="quality-menu" id="playlistQualityMenu"></div>
        </div>
      </div>
    </div>
    
    <!-- Updated Search Bar - Search icon + Clear (cross) icon -->
    <div class="search-bar" id="searchBar">
      <!-- Search Icon Button -->
      <button class="search-button" onclick="performSearch()" aria-label="Search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="2" 
             stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>

      <!-- Input with Clear Button -->
      <div style="position: relative; flex: 1; display: flex; align-items: center;">
        <input type="text" id="searchInput" class="search-input"
               placeholder="Search channels..."
               oninput="searchChannels(this.value)"
               aria-label="Search channels">
        <!-- Clear (Cross) Icon Button -->
        <button class="clear-button" onclick="clearSearch()" aria-label="Clear search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
    <div id="channelGrid" class="grid"></div>
  </div>

</div>

<!-- BOTTOM NAVIGATION -->
<div class="bottom-nav">
  <a href="#" class="nav-item active" onclick="navigateTo('homepage'); return false;">
    <svg class="nav-icon" viewBox="0 0 24 24">
      <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
    <span>Home</span>
  </a>
  <a href="#" class="nav-item" onclick="navigateTo('networkStreamPage'); return false;">
    <svg class="nav-icon" viewBox="0 0 24 24">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
    </svg>
    <span>Direct</span>
  </a>
  <a href="#" class="nav-item" onclick="navigateTo('playlistPage'); return false;">
    <svg class="nav-icon" viewBox="0 0 24 24">
      <path d="M19 9H2v2h17V9zm0-4H2v2h17V5zm0 8H2v2h17v-2zm0 4H2v2h17v-2zM2 3v2h17V3H2z"/>
    </svg>
    <span>Playlists</span>
  </a>
  <a href="#" class="nav-item" onclick="navigateTo('favoritesPage'); return false;">
    <svg class="nav-icon" viewBox="0 0 24 24">
      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
    </svg>
    <span>Favorites</span>
  </a>
  <a href="#" class="nav-item" onclick="openSettingsModal(); return false;">
    <svg class="nav-icon" viewBox="0 0 24 24">
      <path d="M19.14,12.94c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
    </svg>
    <span>Settings</span>
  </a>
</div>

<!-- Loading & Toast -->
<div id="loading" class="loading"></div>
<div id="toast" class="toast"></div>

<!-- Edit Playlist Modal -->
<div id="editModal" class="modal" role="dialog" aria-labelledby="editModalTitle">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="editModalTitle">Edit Playlist</h3>
      <button class="modal-close" onclick="closeEditModal()" aria-label="Close">×</button>
    </div>
    <div class="modal-body">
      <label for="editPlaylistName" style="display:block;margin-bottom:4px;">Playlist Name:</label>
      <input type="text" id="editPlaylistName" class="form-input" placeholder="Playlist Name">
      <label for="editPlaylistUrl" style="display:block;margin-bottom:4px;margin-top:12px;">Playlist URL (for URL playlists):</label>
      <input type="text" id="editPlaylistUrl" class="form-input" placeholder="Playlist URL (for URL playlists)">
      <p style="color:var(--text-secondary);font-size:12px;margin-top:8px;">Note: You can only edit the URL for URL-based playlists</p>
    </div>
    <div class="modal-footer">
      <button onclick="closeEditModal()" aria-label="Cancel">Cancel</button>
      <button class="play-btn" onclick="savePlaylistEdit()" aria-label="Save">Save</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" role="dialog" aria-labelledby="settingsModalTitle">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="settingsModalTitle">Settings</h3>
      <button class="modal-close" onclick="closeSettingsModal()" aria-label="Close">×</button>
    </div>
    <div class="modal-body">
      <label for="themeSelect" style="display:block;margin-bottom:4px;">Theme:</label>
      <select id="themeSelect" class="form-input" onchange="changeTheme(this.value)">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="blue">Blue</option>
        <option value="green">Green</option>
      </select>
      
      <label for="fontSizeSelect" style="display:block;margin-bottom:4px;margin-top:12px;">Font Size:</label>
      <select id="fontSizeSelect" class="form-input" onchange="changeFontSize(this.value)">
        <option value="14px">Small</option>
        <option value="16px">Medium</option>
        <option value="18px">Large</option>
      </select>
      
      <label for="progressColorInput" style="display:block;margin-bottom:4px;margin-top:12px;">Progress Bar Color:</label>
      <input type="color" id="progressColorInput" class="form-input" value="#ff0000" onchange="changeProgressColor(this.value)">
      
      <label for="accentColorInput" style="display:block;margin-bottom:4px;margin-top:12px;">Accent Color:</label>
      <input type="color" id="accentColorInput" class="form-input" value="#e74c3c" onchange="changeAccentColor(this.value)">
      
      <label for="bgImageInput" style="display:block;margin-bottom:4px;margin-top:12px;">Background Image URL:</label>
      <input type="text" id="bgImageInput" class="form-input" placeholder="https://example.com/image.jpg" oninput="changeBgImage(this.value)">
      
      <label for="cardRadiusInput" style="display:block;margin-bottom:4px;margin-top:12px;">Card Border Radius:</label>
      <input type="range" id="cardRadiusInput" min="0" max="20" value="12" step="1" onchange="changeCardRadius(this.value)" class="form-input">
      
      <label for="playerRadiusInput" style="display:block;margin-bottom:4px;margin-top:12px;">Player Border Radius:</label>
      <input type="range" id="playerRadiusInput" min="0" max="20" value="0" step="1" onchange="changePlayerRadius(this.value)" class="form-input">
      
      <label for="controlSizeInput" style="display:block;margin-bottom:4px;margin-top:12px;">Control Icons Size:</label>
      <input type="range" id="controlSizeInput" min="16" max="32" value="20" step="2" onchange="changeControlSize(this.value)" class="form-input">
      
      <label for="gridColumnsSelect" style="display:block;margin-bottom:4px;margin-top:12px;">Grid Columns Width:</label>
      <select id="gridColumnsSelect" class="form-input" onchange="changeGridColumns(this.value)">
        <option value="minmax(180px,1fr)">Default (180px)</option>
        <option value="minmax(140px,1fr)">Small (140px)</option>
        <option value="minmax(220px,1fr)">Large (220px)</option>
      </select>
      
      <label for="playerAspectSelect" style="display:block;margin-bottom:4px;margin-top:12px;">Player Aspect Ratio:</label>
      <select id="playerAspectSelect" class="form-input" onchange="changePlayerAspect(this.value)">
        <option value="16/9">16:9 (Widescreen)</option>
        <option value="4/3">4:3 (Standard)</option>
        <option value="1/1">1:1 (Square)</option>
        <option value="auto">Auto</option>
      </select>
      
      <label for="progressHeightInput" style="display:block;margin-bottom:4px;margin-top:12px;">Seekbar Height:</label>
      <input type="range" id="progressHeightInput" min="4" max="10" value="5" step="1" onchange="changeProgressHeight(this.value)" class="form-input">
      
      <label for="bufferedColorInput" style="display:block;margin-bottom:4px;margin-top:12px;">Buffered Bar Color:</label>
      <input type="color" id="bufferedColorInput" class="form-input" value="#ffffff" onchange="changeBufferedColor(this.value)">
      
      <label for="searchRadiusInput" style="display:block;margin-bottom:4px;margin-top:12px;">Search Bar Radius:</label>
      <input type="range" id="searchRadiusInput" min="0" max="30" value="24" step="1" onchange="changeSearchRadius(this.value)" class="form-input">
      
      <label for="searchBorderInput" style="display:block;margin-bottom:4px;margin-top:12px;">Search Border Color:</label>
      <input type="color" id="searchBorderInput" class="form-input" value="#2a2a2a" onchange="changeSearchBorder(this.value)">
    </div>
    <div class="modal-footer">
      <button onclick="resetCustomizations()" aria-label="Reset">Reset to Defaults</button>
      <button onclick="closeSettingsModal()" aria-label="Close">Close</button>
    </div>
  </div>
</div>

<script>
// Global Variables
let playlists = JSON.parse(localStorage.getItem('iptv_playlists')) || [];
let channels = []; 
let favorites = JSON.parse(localStorage.getItem('iptv_favorites')) || [];
let hls = null;
let directHls = null;
let controlsTimeout = {};
let isDraggingProgress = false;
let isSeeking = false;
let currentCategory = 'all';
let currentChannel = null;
let navigationHistory = [];

// Player States with proper event listener tracking
const playerState = {
  direct: {
    video: null,
    player: null,
    controls: null,
    isPlaying: false,
    isMuted: false,
    volume: 1,
    hasPlayed: false,
    eventListeners: []
  },
  playlist: {
    video: null,
    player: null,
    controls: null,
    isPlaying: false,
    isMuted: false,
    volume: 1,
    hasPlayed: false,
    eventListeners: []
  }
};

// Updated navigateTo with search bar clearing and history management
function navigateTo(pageId, push = true) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(page => {
    page.style.display = 'none';
  });

  // Show requested page
  const pageElement = document.getElementById(pageId);
  if (pageElement) {
    pageElement.style.display = 'block';
  }

  // Save current page (so refresh stays here)
  localStorage.setItem('currentPage', pageId);

  // ✅ Always clear search bar when navigating pages
  resetSearchBar();

  // Update active nav styling
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Find and activate the corresponding nav item
  const navItems = document.querySelectorAll('.nav-item');
  for (let item of navItems) {
    const href = item.getAttribute('onclick');
    if (href && href.includes(pageId)) {
      item.classList.add('active');
      break;
    }
  }

  // Push browser history state
  if (push) {
    window.history.pushState({ page: pageId }, '', '#' + pageId);
    // Add to navigation history
    if (navigationHistory.length === 0 || navigationHistory[navigationHistory.length - 1] !== pageId) {
      navigationHistory.push(pageId);
    }
  }

  // Page specific handlers
  if (pageId === "favoritesPage") {
    renderFavorites();
  }

  // Stop videos of other players
  if (pageId !== "playlistPlayerPage") stopPlayer('playlist');
  if (pageId !== "networkStreamPage") stopPlayer('direct');

  toggleSidebar(false);
}

// Reset search bar input when leaving or clearing
function resetSearchBar() {
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.value = '';
    searchChannels('');
  }
}

// Clear search function
function clearSearch() {
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.value = '';
    searchChannels('');
    searchInput.focus();
  }
}

// Perform search function (can be triggered by search button)
function performSearch() {
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchChannels(searchInput.value);
    showToast("Searching...");
  }
}

// Navigation functions
function goBack() {
  // Remove current page from history
  if (navigationHistory.length > 1) {
    navigationHistory.pop(); // Remove current page
    const previousPage = navigationHistory[navigationHistory.length - 1];
    navigateTo(previousPage, false);
  } else {
    // If no history, go to homepage
    navigateTo('homepage', false);
  }
}

// Popstate listener for hardware / browser back button
window.addEventListener('popstate', (event) => {
  const pageId = event.state?.page || 'homepage';
  navigateTo(pageId, false); // don't push again
});

// Initialize Players with proper cleanup
function initializePlayers() {
  // Direct Player
  playerState.direct.video = document.getElementById('directVideo');
  playerState.direct.player = document.getElementById('directPlayer');
  playerState.direct.controls = document.getElementById('directControls');
  
  // Playlist Player
  playerState.playlist.video = document.getElementById('playlistVideo');
  playerState.playlist.player = document.getElementById('playlistPlayer');
  playerState.playlist.controls = document.getElementById('playlistControls');
  
  // Add event listeners with cleanup tracking
  ['direct', 'playlist'].forEach(type => {
    const video = playerState[type].video;
    const player = playerState[type].player;
    const progressContainer = document.getElementById(`${type}ProgressContainer`);
    const loadingIndicator = document.getElementById(`${type}PlayerLoading`);
    
    // Cleanup existing listeners first
    cleanupEventListeners(type);
    
    // Video events with cleanup tracking
    const events = [
      { name: 'play', handler: () => updatePlayState(type, true) },
      { name: 'pause', handler: () => updatePlayState(type, false) },
      { name: 'timeupdate', handler: () => updateProgress(type) },
      { name: 'loadedmetadata', handler: () => updateDuration(type) },
      { name: 'waiting', handler: () => {
          if (!isDraggingProgress && !isSeeking) {
            loadingIndicator.classList.add('show');
          }
        }
      },
      { name: 'canplay', handler: () => {
          loadingIndicator.classList.remove('show');
        }
      },
      { name: 'volumechange', handler: () => updateVolumeIcon(type) },
      { name: 'progress', handler: () => updateBuffered(type) },
      { name: 'loadstart', handler: () => {
          loadingIndicator.classList.add('show');
        }
      },
      { name: 'loadeddata', handler: () => {
          loadingIndicator.classList.remove('show');
        }
      },
      { name: 'error', handler: (e) => {
          loadingIndicator.classList.remove('show');
          showToast("Stream error occurred");
        }
      }
    ];
    
    events.forEach(event => {
      video.addEventListener(event.name, event.handler);
      playerState[type].eventListeners.push({ element: video, event: event.name, handler: event.handler });
    });
    
    // Controls visibility events
    const controlEvents = [
      { name: 'mousemove', handler: () => showControls(type) },
      { name: 'mouseleave', handler: () => hideControls(type) },
      { name: 'touchstart', handler: () => showControls(type) },
      { name: 'click', handler: () => showControls(type) }
    ];
    
    controlEvents.forEach(event => {
      player.addEventListener(event.name, event.handler);
      playerState[type].eventListeners.push({ element: player, event: event.name, handler: event.handler });
    });
    
    // Progress bar events with touch support
    const progressEvents = [
      { name: 'mousedown', handler: (e) => startProgressDrag(e, type) },
      { name: 'mousemove', handler: (e) => showProgressPreview(e, type) },
      { name: 'mouseleave', handler: () => hideProgressPreview(type) },
      { name: 'touchstart', handler: (e) => {
          e.preventDefault();
          startProgressDrag(e.touches[0], type);
        }
      },
      { name: 'touchmove', handler: (e) => {
          e.preventDefault();
          showProgressPreview(e.touches[0], type);
        }
      },
      { name: 'touchend', handler: () => hideProgressPreview(type) },
      { name: 'click', handler: (e) => {
          isSeeking = true;
          seekVideo(e, type);
          setTimeout(() => { isSeeking = false; }, 100);
        }
      }
    ];
    
    progressEvents.forEach(event => {
      progressContainer.addEventListener(event.name, event.handler);
      playerState[type].eventListeners.push({ element: progressContainer, event: event.name, handler: event.handler });
    });
  });
}

// Properly cleanup event listeners
function cleanupEventListeners(type) {
  playerState[type].eventListeners.forEach(({ element, event, handler }) => {
    element.removeEventListener(event, handler);
  });
  playerState[type].eventListeners = [];
}

// Progress bar dragging with proper cleanup
function startProgressDrag(e, type) {
  const video = playerState[type].video;
  if (!video || !isFinite(video.duration)) return;

  isDraggingProgress = true;
  const loadingIndicator = document.getElementById(`${type}PlayerLoading`);
  if (loadingIndicator) loadingIndicator.classList.remove('show');

  seekVideo(e, type);

  const handleMove = (ev) => {
    if (isDraggingProgress) {
      const clientX = ev.touches ? ev.touches[0].clientX : ev.clientX;
      seekVideo({ clientX }, type);
      showProgressPreview(ev, type); // Real-time preview during drag
    }
  };

  const handleEnd = () => {
    isDraggingProgress = false;
    hideProgressPreview(type);
    document.removeEventListener('mousemove', handleMove);
    document.removeEventListener('mouseup', handleEnd);
    document.removeEventListener('touchmove', handleMove);
    document.removeEventListener('touchend', handleEnd);
  };

  document.addEventListener('mousemove', handleMove);
  document.addEventListener('mouseup', handleEnd);
  document.addEventListener('touchmove', handleMove);
  document.addEventListener('touchend', handleEnd);
}

function showProgressPreview(e, type) {
  const progressContainer = document.getElementById(`${type}ProgressContainer`);
  const preview = document.getElementById(`${type}ProgressPreview`);
  const video = playerState[type].video;
  
  if (!progressContainer || !preview || !video || !isFinite(video.duration)) return;
  
  const rect = progressContainer.getBoundingClientRect();
  const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
  let pos = (clientX - rect.left) / rect.width;
  pos = Math.min(1, Math.max(0, pos));
  const time = pos * video.duration;
  
  preview.style.display = 'block';
  preview.style.left = `${clientX - rect.left}px`;
  preview.textContent = formatTime(time);
}

function hideProgressPreview(type) {
  document.getElementById(`${type}ProgressPreview`).style.display = 'none';
}

function updateBuffered(type) {
  const video = playerState[type].video;
  const buffered = document.getElementById(`${type}ProgressBuffered`);
  
  if (video.buffered.length > 0 && video.duration) {
    const bufferedEnd = video.buffered.end(video.buffered.length - 1);
    const percent = (bufferedEnd / video.duration) * 100;
    buffered.style.width = percent + '%';
  }
}

// -------- UI HELPERS
function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showToast(message, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', duration);
}

// -------- SIDEBAR
function toggleSidebar(show) {
  document.getElementById("sidebar").style.width = show ? "250px" : "0";
}

// -------- FAB
function toggleFabMenu() {
  const menu = document.getElementById('fabMenu');
  menu.style.display = menu.style.display === "flex" ? "none" : "flex";
}

// -------- CUSTOM PLAYER CONTROLS
function togglePlayPause(type) {
  const video = playerState[type].video;
  if (video.paused) {
    video.play();
  } else {
    video.pause();
  }
}

function updatePlayState(type, isPlaying) {
  playerState[type].isPlaying = isPlaying;
  const player = playerState[type].player;
  const playIcon = document.getElementById(`${type}PlayIcon`);
  const centerIcon = document.getElementById(`${type}CenterIcon`);
  
  if (isPlaying) {
    player.classList.add('playing');
    player.classList.remove('paused');
    playIcon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
    centerIcon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
  } else {
    player.classList.remove('playing');
    player.classList.add('paused');
    playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
    centerIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
  }
}

function updateProgress(type) {
  if (isDraggingProgress) return;
  
  const video = playerState[type].video;
  const progressBar = document.getElementById(`${type}Progress`);
  const currentTimeEl = document.getElementById(`${type}CurrentTime`);
  
  if (!video || !progressBar || !currentTimeEl || !isFinite(video.duration)) {
    progressBar.style.width = '0%';
    currentTimeEl.textContent = 'Live';
    return;
  }
  
  const progress = (video.currentTime / video.duration) * 100;
  progressBar.style.width = `${progress}%`;
  currentTimeEl.textContent = formatTime(video.currentTime);
}

function updateDuration(type) {
  const video = playerState[type].video;
  const durationEl = document.getElementById(`${type}Duration`);
  if (!durationEl || !video) return;
  durationEl.textContent = isFinite(video.duration) ? formatTime(video.duration) : 'Live';
}

function formatTime(seconds) {
  if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
  const minutes = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

function seekVideo(event, type) {
  const progressContainer = document.getElementById(`${type}ProgressContainer`);
  const video = playerState[type].video;
  const loadingIndicator = document.getElementById(`${type}PlayerLoading`);
  
  if (!progressContainer || !video || !isFinite(video.duration)) return;

  const rect = progressContainer.getBoundingClientRect();
  const clientX = event.clientX || (event.touches && event.touches[0].clientX) || 0;
  let pos = (clientX - rect.left) / rect.width;
  pos = Math.min(1, Math.max(0, pos));
  
  if (loadingIndicator) loadingIndicator.classList.remove('show');
  video.currentTime = pos * video.duration;
}

function toggleMute(type) {
  const video = playerState[type].video;
  if (!video) return;
  video.muted = !video.muted;
  playerState[type].isMuted = video.muted;
  updateVolumeIcon(type);
}

function updateVolumeIcon(type) {
  const video = playerState[type].video;
  const volumeIcon = document.getElementById(`${type}VolumeIcon`);
  
  if (video.muted || video.volume === 0) {
    // Muted icon
    volumeIcon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm5.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C22.98 14.82 23 13.43 23 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>';
  } else {
    // Unmuted icon (full volume)
    volumeIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
  }
}

// PiP functionality with portrait-only restriction
async function togglePiP(type) {
  const video = playerState[type].video;
  
  // Check if in landscape mode
  if (document.body.classList.contains('fullscreen-mode')) {
    showToast("PiP not available in landscape mode");
    return;
  }
  
  try {
    if (video !== document.pictureInPictureElement) {
      await video.requestPictureInPicture();
    } else {
      await document.exitPictureInPicture();
    }
  } catch (error) {
    showToast("PiP not supported or blocked by browser");
  }
}

function toggleFullscreen(type) {
  const player = playerState[type].player;
  const icon = document.getElementById(`${type}FullscreenIcon`);
  
  // Disable fullscreen in landscape mode
  if (document.body.classList.contains('fullscreen-mode')) {
    showToast("Fullscreen not available in landscape mode");
    return;
  }
  
  if (!document.fullscreenElement) {
    player.requestFullscreen().then(() => {
      icon.innerHTML = '<path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>';
    });
  } else {
    document.exitFullscreen().then(() => {
      icon.innerHTML = '<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>';
    });
  }
}

function rotateScreen() {
  const isFullscreen = document.body.classList.contains('fullscreen-mode');
  
  if (!isFullscreen) {
    // Enter fullscreen mode
    document.body.classList.add('fullscreen-mode');
    
    // Try to lock orientation
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock('landscape').catch(() => {
        // If lock fails, try fullscreen API
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
          elem.requestFullscreen().then(() => {
            screen.orientation.lock('landscape').catch(() => {});
          });
        }
      });
    }
    showToast("Rotated to landscape");
    
    // Disable fullscreen buttons in landscape
    document.getElementById('directFullscreenBtn').disabled = true;
    document.getElementById('playlistFullscreenBtn').disabled = true;
  } else {
    // Exit fullscreen mode
    document.body.classList.remove('fullscreen-mode');
    
    if (document.fullscreenElement) {
      document.exitFullscreen();
    }
    
    if (screen.orientation && screen.orientation.unlock) {
      screen.orientation.unlock();
    }
    showToast("Rotated to portrait");
    
    // Enable fullscreen buttons in portrait
    document.getElementById('directFullscreenBtn').disabled = false;
    document.getElementById('playlistFullscreenBtn').disabled = false;
  }
}

function showControls(type) {
  const player = playerState[type].player;
  
  player.classList.add('show-controls');
  
  // Clear existing timeout
  if (controlsTimeout[type]) {
    clearTimeout(controlsTimeout[type]);
  }
  
  // Hide controls after 3 seconds if playing
  if (playerState[type].isPlaying) {
    controlsTimeout[type] = setTimeout(() => {
      player.classList.remove('show-controls');
    }, 3000);
  }
}

function hideControls(type) {
  if (playerState[type].isPlaying) {
    const player = playerState[type].player;
    player.classList.remove('show-controls');
  }
}

function toggleQualityMenu(type) {
  const menu = document.getElementById(`${type}QualityMenu`);
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

// -------- PLAYBACK FUNCTIONS
function stopPlayer(type) {
  const video = playerState[type].video;
  if (video) {
    video.pause();
    video.removeAttribute("src");
    video.load();
  }
  
  // Properly destroy HLS instances
  if (type === 'direct' && directHls) {
    directHls.destroy();
    directHls = null;
  } else if (type === 'playlist' && hls) {
    hls.destroy();
    hls = null;
  }
  
  // Reset loading state
  const player = playerState[type].player;
  const loadingIndicator = document.getElementById(`${type}PlayerLoading`);
  if (player) {
    loadingIndicator.classList.remove('show');
  }
  
  // Close quality menu if open
  const qualityMenu = document.getElementById(`${type}QualityMenu`);
  if (qualityMenu) {
    qualityMenu.style.display = 'none';
  }
  
  // Cleanup event listeners
  cleanupEventListeners(type);
}

// -------- DIRECT STREAM PLAYER
function playDirectStream() {
  const url = document.getElementById('streamUrl').value.trim();
  if (!url) {
    showToast("Please enter a stream URL");
    return;
  }

  // Validate URL format
  try {
    new URL(url);
  } catch (e) {
    showToast("Please enter a valid URL");
    return;
  }

  const video = playerState.direct.video;
  const player = playerState.direct.player;
  const streamInfo = document.getElementById('streamInfo');
  const loadingIndicator = document.getElementById('directPlayerLoading');
  
  stopPlayer('direct');
  
  // Re-initialize event listeners
  initializePlayers();
  
  player.style.display = 'block';
  streamInfo.style.display = 'block';
  document.getElementById('streamUrlInfo').textContent = `URL: ${url}`;
  document.getElementById('streamStatus').textContent = 'Status: Connecting...';
  document.getElementById('streamQuality').textContent = '';
  document.getElementById('directTitle').textContent = 'Direct Stream';
  
  // Show player loading indicator
  loadingIndicator.classList.add('show');
  
  if (Hls.isSupported() && (url.includes('.m3u8') || url.includes('m3u8'))) {
    directHls = new Hls({
      enableWorker: true,
      lowLatencyMode: true,
    });
    
    directHls.loadSource(url);
    directHls.attachMedia(video);
    
    directHls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
      loadingIndicator.classList.remove('show');
      document.getElementById('streamStatus').textContent = 'Status: Connected (HLS)';
      
      // AUTO-PLAY THE VIDEO
      video.play().catch(err => {
        console.log('Auto-play prevented:', err);
        showToast('Click play to start');
      });
      
      // Build quality menu with auto option
      const menu = document.getElementById('directQualityMenu');
      menu.innerHTML = '<div class="quality-menu-header">Video Quality</div>';
      menu.innerHTML += '<div class="quality-option active" data-level="-1">Auto</div>';
      
      data.levels.forEach((level, index) => {
        let qualityText = '';
        if (level.height) {
          qualityText = `${level.height}p`;
          if (level.bitrate) {
            qualityText += ` (${Math.round(level.bitrate/1000)}kbps)`;
          }
        } else if (level.bitrate) {
          qualityText = `${Math.round(level.bitrate/1000)}kbps`;
        }
        menu.innerHTML += `<div class="quality-option" data-level="${index}">${qualityText}</div>`;
      });
      
      // Add click handlers
      [...menu.querySelectorAll('.quality-option')].forEach(el => {
        el.onclick = () => {
          directHls.currentLevel = parseInt(el.dataset.level);
          [...menu.querySelectorAll('.quality-option')].forEach(item => item.classList.remove('active'));
          el.classList.add('active');
          menu.style.display = "none";
          
          const selectedQuality = el.dataset.level === '-1' ? 'Auto' : el.textContent;
          showToast(`Quality: ${selectedQuality}`);
          document.getElementById('streamQuality').textContent = `Quality: ${selectedQuality}`;
        };
      });
    });
    
    directHls.on(Hls.Events.ERROR, (event, data) => {
      loadingIndicator.classList.remove('show');
      if (data.fatal) {
        showToast("Stream error: " + data.type);
        document.getElementById('streamStatus').textContent = 'Status: Error - ' + data.type;
      }
    });
  } else {
    // Direct playback with error handling
    video.src = url;
    loadingIndicator.classList.remove('show');
    document.getElementById('streamStatus').textContent = 'Status: Connected (Direct)';
    
    // AUTO-PLAY FOR DIRECT STREAMS
    video.addEventListener('loadeddata', () => {
      video.play().catch(err => {
        console.log('Auto-play prevented:', err);
        showToast('Click play to start');
      });
    }, { once: true });
  }
}

// -------- PLAYLIST PLAYBACK
function playChannel(url, channelName = '', channel = null) {
  // Validate URL
  try {
    new URL(url);
  } catch (e) {
    showToast("Invalid channel URL");
    return;
  }

  const video = playerState.playlist.video;
  const player = playerState.playlist.player;
  const loadingIndicator = document.getElementById('playlistPlayerLoading');
  
  // Show player page only when first channel is clicked
  if (!playerState.playlist.hasPlayed) {
    navigateTo('playlistPlayerPage');
    player.style.display = 'block';
    playerState.playlist.hasPlayed = true;
  }
  
  stopPlayer('playlist');
  
  // Re-initialize event listeners
  initializePlayers();
  
  document.getElementById('playlistTitle').textContent = channelName || 'Channel';
  
  // Show player loading indicator
  loadingIndicator.classList.add('show');
  
  if (Hls.isSupported() && (url.includes('.m3u8') || url.includes('m3u8'))) {
    hls = new Hls({
      enableWorker: true,
      lowLatencyMode: true,
    });
    
    hls.loadSource(url);
    hls.attachMedia(video);
    
    hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
      loadingIndicator.classList.remove('show');
      
      // AUTO-PLAY THE VIDEO
      video.play().catch(err => {
        console.log('Auto-play prevented:', err);
        showToast('Click play to start');
      });
      
      // Build quality menu with auto option
      const menu = document.getElementById('playlistQualityMenu');
      menu.innerHTML = '<div class="quality-menu-header">Video Quality</div>';
      menu.innerHTML += '<div class="quality-option active" data-level="-1">Auto</div>';
      
      data.levels.forEach((level, index) => {
        let qualityText = '';
        if (level.height) {
          qualityText = `${level.height}p`;
          if (level.bitrate) {
            qualityText += ` (${Math.round(level.bitrate/1000)}kbps)`;
          }
        } else if (level.bitrate) {
          qualityText = `${Math.round(level.bitrate/1000)}kbps`;
        }
        menu.innerHTML += `<div class="quality-option" data-level="${index}">${qualityText}</div>`;
      });
      
      // Add click handlers
      [...menu.querySelectorAll('.quality-option')].forEach(el => {
        el.onclick = () => {
          hls.currentLevel = parseInt(el.dataset.level);
          [...menu.querySelectorAll('.quality-option')].forEach(item => item.classList.remove('active'));
          el.classList.add('active');
          menu.style.display = "none";
          
          const selectedQuality = el.dataset.level === '-1' ? 'Auto' : el.textContent;
          showToast(`Quality: ${selectedQuality}`);
        };
      });
    });
    
    hls.on(Hls.Events.ERROR, (event, data) => {
      loadingIndicator.classList.remove('show');
      if (data.fatal) {
        showToast("Stream error: " + data.type);
      }
    });
  } else {
    video.src = url;
    loadingIndicator.classList.remove('show');
    
    // For direct playback
    video.addEventListener('loadeddata', () => {
      video.play().catch(err => {
        console.log('Auto-play prevented:', err);
        showToast('Click play to start');
      });
    }, { once: true });
  }
  
  if (channelName) {
    showToast(`Playing: ${channelName}`);
  }
}

function copyChannel(channel) {
  const text = channel.link + (channel.cookie ? `\nCookie: ${channel.cookie}` : "");
  navigator.clipboard.writeText(text).then(() => {
    showToast("Stream URL copied!");
  }).catch(() => {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast("Stream URL copied!");
  });
}

// -------- FAVORITES MANAGEMENT
function toggleFavorite(channel) {
  const index = favorites.findIndex(fav => fav.link === channel.link);
  
  if (index > -1) {
    // Remove from favorites
    favorites.splice(index, 1);
    showToast("Removed from favorites");
  } else {
    // Add to favorites
    favorites.push(channel);
    showToast("Added to favorites");
  }
  
  // Save to localStorage
  localStorage.setItem('iptv_favorites', JSON.stringify(favorites));
  
  // Update UI if on favorites page
  if (document.getElementById('favoritesPage').style.display !== 'none') {
    renderFavorites();
  }
  
  // Re-render channels to update favorite buttons
  if (document.getElementById('playlistPlayerPage').style.display !== 'none') {
    renderChannels(channels);
  }
}

function renderFavorites() {
  const grid = document.getElementById('favoritesGrid');
  const emptyState = document.getElementById('emptyFavorites');
  
  if (favorites.length === 0) {
    grid.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  
  grid.style.display = 'grid';
  emptyState.style.display = 'none';
  
  grid.innerHTML = favorites.map((ch, index) => `
    <div class="card" data-index="${index}" onclick="playChannel('${ch.link.replace(/'/g, "\\'")}', '${ch.name.replace(/'/g, "\\'")}')" role="button" tabindex="0">
      <div class="thumbnail-container">
        <img src="${ch.logo || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iODAiIGZpbGw9IiMyYTJhMmEiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCI+Tm8gTG9nbzwvdGV4dD48L3N2Zz4='}" 
             class="thumbnail" 
             loading="lazy"
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iODAiIGZpbGw9IiMyYTJhMmEiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCI+Tm8gTG9nbzwvdGV4dD48L3N2Zz4='">
        <div class="play-overlay">
          <div class="play-overlay-btn">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          </div>
        </div>
      </div>
      <div class="card-content">
        <div class="channel-name" title="${ch.name}">${ch.name}</div>
        ${ch.category_name ? `<div class="channel-category">${ch.category_name}</div>` : ''}
        <div class="btn-group">
          <button class="copy-btn" onclick='event.stopPropagation(); copyChannel(${JSON.stringify(ch).replace(/'/g, "\\'")})'>📋 Copy</button>
          <button class="fav-btn" onclick='event.stopPropagation(); toggleFavorite(${JSON.stringify(ch).replace(/'/g, "\\'")})'>⭐ Remove</button>
        </div>
      </div>
    </div>
  `).join('');
}

// -------- CHANNEL RENDERING
function renderChannels(channelList) {
  const grid = document.getElementById('channelGrid');
  
  if (channelList.length === 0) {
    grid.innerHTML = '<div class="empty-state"><h3>No channels found</h3></div>';
    return;
  }
  
  grid.innerHTML = channelList.map((ch, index) => {
    const isFavorite = favorites.some(fav => fav.link === ch.link);
    return `
      <div class="card" data-index="${index}" onclick="playChannel('${ch.link.replace(/'/g, "\\'")}', '${ch.name.replace(/'/g, "\\'")}')" role="button" tabindex="0">
        <div class="thumbnail-container">
          <img src="${ch.logo || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iODAiIGZpbGw9IiMyYTJhMmEiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCI+Tm8gTG9nbzwvdGV4dD48L3N2Zz4='}" 
               class="thumbnail" 
               loading="lazy"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iODAiIGZpbGw9IiMyYTJhMmEiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCI+Tm8gTG9nbzwvdGV4dD48L3N2Zz4='">
          <div class="play-overlay">
            <div class="play-overlay-btn">
              <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </div>
          </div>
        </div>
        <div class="card-content">
          <div class="channel-name" title="${ch.name}">${ch.name}</div>
          ${ch.category_name ? `<div class="channel-category">${ch.category_name}</div>` : ''}
          <div class="btn-group">
            <button class="copy-btn" onclick='event.stopPropagation(); copyChannel(${JSON.stringify(ch).replace(/'/g, "\\'")})'>📋 Copy</button>
            <button class="${isFavorite ? 'fav-btn' : 'add-fav-btn'}" onclick='event.stopPropagation(); toggleFavorite(${JSON.stringify(ch).replace(/'/g, "\\'")})'>${isFavorite ? '⭐ Remove' : '☆ Add Fav'}</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function searchChannels(query) {
  const filtered = query.trim() === '' 
    ? channels 
    : channels.filter(ch => 
        ch.name.toLowerCase().includes(query.toLowerCase()) ||
        (ch.category_name && ch.category_name.toLowerCase().includes(query.toLowerCase()))
      );
  renderChannels(filtered);
}

// -------- M3U PARSER
function parseM3U(text) {
  const lines = text.split(/\r?\n/);
  const parsed = [];
  let current = {};
  let globalCookie = null;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    if (line.startsWith('#EXTINF')) {
      const attrs = {};
      const attrRegex = /([\w\-]+)="([^"]*)"/g;
      let match;
      while ((match = attrRegex.exec(line)) !== null) {
        attrs[match[1]] = match[2];
      }
      
      const nameMatch = line.match(/,(.+)$/);
      const channelName = attrs['tvg-name'] || attrs['tvg-id'] || (nameMatch ? nameMatch[1].trim() : 'Unnamed');
      
      current = {
        name: channelName,
        logo: attrs['tvg-logo'] || attrs['logo'] || null,
        category_name: attrs['group-title'] || attrs['tvg-group'] || null,
        link: null,
        cookie: null,
        id: attrs['tvg-id'] || null
      };
    } else if (line.startsWith('#EXTHTTP')) {
      try {
        const httpData = JSON.parse(line.replace('#EXTHTTP:', '').trim());
        if (httpData.cookie) {
          globalCookie = httpData.cookie;
        }
      } catch (e) {
        console.warn('Failed to parse EXTHTTP:', e);
      }
    } else if (!line.startsWith('#') && line.length > 0) {
      if (current.name) {
        current.link = line;
        if (globalCookie) {
          current.cookie = globalCookie;
          globalCookie = null;
        }
        parsed.push(current);
        current = {};
      }
    }
  }
  
  return parsed;
}

// -------- PLAYLIST MANAGEMENT
function savePlaylists() {
  localStorage.setItem('iptv_playlists', JSON.stringify(playlists));
}

function renderPlaylists() {
  const list = document.getElementById('playlistList');
  const emptyState = document.getElementById('emptyPlaylist');
  
  if (playlists.length === 0) {
    list.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  
  list.style.display = 'block';
  emptyState.style.display = 'none';
  
  list.innerHTML = playlists.map((playlist, index) => `
    <div class="playlist-item">
      <div>
        <div class="playlist-name">${playlist.name}</div>
        <small style="color:var(--text-secondary);">${playlist.type === 'url' ? '🔗 URL' : '📁 File'}</small>
        ${playlist.type === 'url' ? `<div class="playlist-url">${playlist.url}</div>` : ''}
      </div>
      <div class="playlist-actions">
        <button onclick="loadPlaylist(${index})" class="play-btn">▶ Load</button>
        <button onclick="openEditModal(${index})">✏️ Edit</button>
        <button onclick="deletePlaylist(${index})" style="background:var(--accent);">🗑️</button>
      </div>
    </div>
  `).join('');
}

// -------- EDIT MODAL
let currentEditIndex = -1;

function openEditModal(index) {
  currentEditIndex = index;
  const playlist = playlists[index];
  
  document.getElementById('editPlaylistName').value = playlist.name;
  document.getElementById('editPlaylistUrl').value = playlist.type === 'url' ? playlist.url : '';
  document.getElementById('editPlaylistUrl').disabled = playlist.type !== 'url';
  
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  currentEditIndex = -1;
}

function savePlaylistEdit() {
  if (currentEditIndex === -1) return;
  
  const newName = document.getElementById('editPlaylistName').value.trim();
  const newUrl = document.getElementById('editPlaylistUrl').value.trim();
  
  if (!newName) {
    showToast("Please enter a playlist name");
    return;
  }
  
  // Validate URL if it's a URL playlist
  if (playlists[currentEditIndex].type === 'url' && newUrl) {
    try {
      new URL(newUrl);
    } catch (e) {
      showToast("Please enter a valid URL");
      return;
    }
    playlists[currentEditIndex].url = newUrl;
  }
  
  playlists[currentEditIndex].name = newName;
  
  savePlaylists();
  renderPlaylists();
  closeEditModal();
  showToast("Playlist updated successfully!");
}

function addPlaylistUrl() {
  const url = prompt("Enter playlist URL (m3u/m3u8):");
  if (!url) return;
  
  // Validate URL
  try {
    new URL(url);
  } catch (e) {
    showToast("Please enter a valid URL");
    return;
  }
  
  const name = prompt("Playlist name:", "Playlist " + (playlists.length + 1));
  if (!name) return;
  
  playlists.push({
    name: name,
    url: url,
    type: "url"
  });
  
  savePlaylists();
  renderPlaylists();
  toggleFabMenu();
  showToast("Playlist added successfully!");
}

function addPlaylistFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Validate file type
  if (!file.name.match(/\.(m3u|m3u8)$/i)) {
    showToast("Please upload a valid M3U/M3U8 file");
    return;
  }
  
  const reader = new FileReader();
  reader.onload = () => {
    const name = prompt("Playlist name:", file.name.replace(/\.[^/.]+$/, ""));
    if (!name) return;
    
    playlists.push({
      name: name,
      data: reader.result,
      type: "file"
    });
    
    savePlaylists();
    renderPlaylists();
    toggleFabMenu();
    showToast("Playlist added successfully!");
  };
  
  reader.readAsText(file);
  event.target.value = ''; // Reset file input
}

function deletePlaylist(index) {
  if (confirm(`Delete "${playlists[index].name}"?`)) {
    playlists.splice(index, 1);
    savePlaylists();
    renderPlaylists();
    showToast("Playlist deleted!");
  }
}

// Enhanced playlist loading with better error handling and HTML support
async function loadPlaylist(index) {
  showLoading(true);
  
  try {
    const playlist = playlists[index];
    let content;
    
    if (playlist.type === "url") {
      // Try to fetch the playlist with better error handling
      const response = await fetch(playlist.url, {
        method: 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        }
      });
      
      if (!response.ok) {
        throw new Error(`Failed to fetch playlist: ${response.status} ${response.statusText}`);
      }
      
      const contentType = response.headers.get('content-type') || '';
      content = await response.text();
      
      // Handle HTML pages that might contain M3U links
      if (contentType.includes('text/html')) {
        console.log('HTML page detected, parsing for M3U links...');
        content = await extractM3UFromHTML(content, playlist.url);
      }
    } else {
      content = playlist.data;
    }
    
    channels = parseM3U(content);
    if (channels.length === 0) {
      throw new Error('No channels found in playlist');
    }
    
    // Reset player state when loading new playlist
    playerState.playlist.hasPlayed = false;
    document.getElementById('playlistPlayer').style.display = 'none';
    
    renderChannels(channels);
    navigateTo('playlistPlayerPage');
    showLoading(false);
    showToast(`Loaded ${channels.length} channels`);
  } catch (error) {
    showLoading(false);
    console.error('Playlist loading error:', error);
    showToast("Failed to load playlist: " + error.message);
  }
}

// Function to extract M3U links from HTML pages
async function extractM3UFromHTML(htmlContent, originalUrl) {
  try {
    // Look for common patterns where M3U URLs might be embedded
    const m3uPatterns = [
      /href=["']([^"']*\.m3u8?[^"']*)["']/gi,
      /src=["']([^"']*\.m3u8?[^"']*)["']/gi,
      /url:["']([^"']*\.m3u8?[^"']*)["']/gi,
      /playlist["']?\s*:\s*["']([^"']*\.m3u8?[^"']*)["']/gi,
      /getKATEX_INLINE_OPEN["']([^"']*\.m3u8?[^"']*)["']/gi
    ];
    
    for (const pattern of m3uPatterns) {
      const matches = [...htmlContent.matchAll(pattern)];
      if (matches.length > 0) {
        // Try the first found M3U URL
        const m3uUrl = new URL(matches[0][1], originalUrl).href;
        console.log('Found potential M3U URL:', m3uUrl);
        
        try {
          const response = await fetch(m3uUrl);
          if (response.ok) {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('mpegurl') || contentType.includes('m3u') || m3uUrl.endsWith('.m3u') || m3uUrl.endsWith('.m3u8')) {
              return await response.text();
            }
          }
        } catch (e) {
          console.log('Failed to fetch potential M3U URL:', m3uUrl);
        }
      }
    }
    
    // If no M3U URL found in HTML, return original content
    return htmlContent;
  } catch (error) {
    console.error('Error extracting M3U from HTML:', error);
    return htmlContent;
  }
}

// -------- EXPORT/IMPORT
function exportPlaylists() {
  if (playlists.length === 0) {
    showToast("No playlists to export");
    return;
  }
  
  const data = JSON.stringify(playlists, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'iptv-playlists-backup.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast("Playlists exported!");
}

function importPlaylists() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const imported = JSON.parse(reader.result);
        if (Array.isArray(imported)) {
          playlists = [...playlists, ...imported];
          savePlaylists();
          renderPlaylists();
          showToast(`Imported ${imported.length} playlists!`);
        } else {
          showToast("Invalid backup file");
        }
      } catch (error) {
        showToast("Failed to import: " + error.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// -------- CUSTOMIZATION FUNCTIONS
function openSettingsModal() {
  // Load saved settings
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.getElementById('themeSelect').value = savedTheme;
  
  const savedFontSize = localStorage.getItem('fontSize') || '16px';
  document.getElementById('fontSizeSelect').value = savedFontSize;
  
  const savedProgressColor = localStorage.getItem('progressColor') || '#ff0000';
  document.getElementById('progressColorInput').value = savedProgressColor;
  
  const savedAccentColor = localStorage.getItem('accentColor') || '#e74c3c';
  document.getElementById('accentColorInput').value = savedAccentColor;
  
  const savedBgImage = localStorage.getItem('bgImage') || '';
  document.getElementById('bgImageInput').value = savedBgImage;
  
  const savedCardRadius = localStorage.getItem('cardRadius') || '12';
  document.getElementById('cardRadiusInput').value = savedCardRadius;
  
    const savedPlayerRadius = localStorage.getItem('playerRadius') || '0';
  changePlayerRadius(savedPlayerRadius);
  
  const savedControlSize = localStorage.getItem('controlSize') || '20';
  changeControlSize(savedControlSize);
  
  const savedGridColumns = localStorage.getItem('gridColumns') || 'minmax(180px,1fr)';
  changeGridColumns(savedGridColumns);
  
  const savedPlayerAspect = localStorage.getItem('playerAspect') || '16/9';
  changePlayerAspect(savedPlayerAspect);
  
  const savedProgressHeight = localStorage.getItem('progressHeight') || '5';
  changeProgressHeight(savedProgressHeight);
  
  const savedBufferedColor = localStorage.getItem('bufferedColor') || '#ffffff';
  changeBufferedColor(savedBufferedColor);
  
  const savedSearchRadius = localStorage.getItem('searchRadius') || '24';
  changeSearchRadius(savedSearchRadius);
  
  const savedSearchBorder = localStorage.getItem('searchBorder') || '#2a2a2a';
  changeSearchBorder(savedSearchBorder);
  
  document.getElementById('settingsModal').style.display = 'flex';
  toggleSidebar(false);
}

function closeSettingsModal() {
  document.getElementById('settingsModal').style.display = 'none';
}

function changeTheme(theme) {
  const body = document.body;
  body.classList.remove('light-theme', 'blue-theme', 'green-theme');
  if (theme !== 'dark') {
    body.classList.add(`${theme}-theme`);
  }
  localStorage.setItem('theme', theme);
  showToast(`Theme changed to ${theme}`);
}

function changeFontSize(size) {
  document.documentElement.style.setProperty('--font-size-base', size);
  localStorage.setItem('fontSize', size);
  showToast(`Font size changed to ${size}`);
}

function changeProgressColor(color) {
  document.documentElement.style.setProperty('--progress-color', color);
  localStorage.setItem('progressColor', color);
  showToast('Progress color updated');
}

function changeAccentColor(color) {
  document.documentElement.style.setProperty('--accent', color);
  localStorage.setItem('accentColor', color);
  showToast('Accent color updated');
}

function changeBgImage(url) {
  if (url) {
    document.documentElement.style.setProperty('--bg-image', `url(${url})`);
  } else {
    document.documentElement.style.setProperty('--bg-image', 'none');
  }
  localStorage.setItem('bgImage', url);
  showToast('Background image updated');
}

function changeCardRadius(radius) {
  document.documentElement.style.setProperty('--card-border-radius', `${radius}px`);
  localStorage.setItem('cardRadius', radius);
  showToast(`Card radius set to ${radius}px`);
}

function changePlayerRadius(radius) {
  document.documentElement.style.setProperty('--player-border-radius', `${radius}px`);
  localStorage.setItem('playerRadius', radius);
  showToast(`Player radius set to ${radius}px`);
}

function changeControlSize(size) {
  document.documentElement.style.setProperty('--control-size', `${size}px`);
  localStorage.setItem('controlSize', size);
  showToast(`Control size set to ${size}px`);
}

function changeGridColumns(value) {
  document.documentElement.style.setProperty('--grid-columns', value);
  localStorage.setItem('gridColumns', value);
  showToast('Grid columns updated');
  // Re-render channels if on player page
  if (document.getElementById('playlistPlayerPage').style.display !== 'none') {
    renderChannels(channels);
  }
}

function changePlayerAspect(value) {
  document.documentElement.style.setProperty('--player-aspect', value === 'auto' ? 'auto' : value);
  localStorage.setItem('playerAspect', value);
  showToast('Player aspect ratio updated');
}

function changeProgressHeight(height) {
  document.documentElement.style.setProperty('--progress-height', `${height}px`);
  localStorage.setItem('progressHeight', height);
  showToast(`Seekbar height set to ${height}px`);
}

function changeBufferedColor(color) {
  document.documentElement.style.setProperty('--buffered-color', `rgba(${parseInt(color.substr(1,2),16)},${parseInt(color.substr(3,2),16)},${parseInt(color.substr(5,2),16)},0.4)`);
  localStorage.setItem('bufferedColor', color);
  showToast('Buffered color updated');
}

function changeSearchRadius(radius) {
  document.documentElement.style.setProperty('--search-radius', `${radius}px`);
  localStorage.setItem('searchRadius', radius);
  showToast(`Search bar radius set to ${radius}px`);
}

function changeSearchBorder(color) {
  document.documentElement.style.setProperty('--search-border', color);
  localStorage.setItem('searchBorder', color);
  showToast('Search border color updated');
}

function resetCustomizations() {
  // Reset all CSS variables to defaults
  document.documentElement.style.setProperty('--font-size-base', '16px');
  document.documentElement.style.setProperty('--progress-color', '#ff0000');
  document.documentElement.style.setProperty('--accent', '#e74c3c');
  document.documentElement.style.setProperty('--bg-image', 'none');
  document.documentElement.style.setProperty('--card-border-radius', '12px');
  document.documentElement.style.setProperty('--player-border-radius', '0px');
  document.documentElement.style.setProperty('--control-size', '20px');
  document.documentElement.style.setProperty('--grid-columns', 'minmax(180px,1fr)');
  document.documentElement.style.setProperty('--player-aspect', '16/9');
  document.documentElement.style.setProperty('--progress-height', '5px');
  document.documentElement.style.setProperty('--buffered-color', 'rgba(255,255,255,0.4)');
  document.documentElement.style.setProperty('--search-radius', '24px');
  document.documentElement.style.setProperty('--search-border', '#2a2a2a');
  
  // Reset all localStorage items
  localStorage.removeItem('theme');
  localStorage.removeItem('fontSize');
  localStorage.removeItem('progressColor');
  localStorage.removeItem('accentColor');
  localStorage.removeItem('bgImage');
  localStorage.removeItem('cardRadius');
  localStorage.removeItem('playerRadius');
  localStorage.removeItem('controlSize');
  localStorage.removeItem('gridColumns');
  localStorage.removeItem('playerAspect');
  localStorage.removeItem('progressHeight');
  localStorage.removeItem('bufferedColor');
  localStorage.removeItem('searchRadius');
  localStorage.removeItem('searchBorder');
  
  // Reset form values
  document.getElementById('themeSelect').value = 'dark';
  document.getElementById('fontSizeSelect').value = '16px';
  document.getElementById('progressColorInput').value = '#ff0000';
  document.getElementById('accentColorInput').value = '#e74c3c';
  document.getElementById('bgImageInput').value = '';
  document.getElementById('cardRadiusInput').value = '12';
  document.getElementById('playerRadiusInput').value = '0';
  document.getElementById('controlSizeInput').value = '20';
  document.getElementById('gridColumnsSelect').value = 'minmax(180px,1fr)';
  document.getElementById('playerAspectSelect').value = '16/9';
  document.getElementById('progressHeightInput').value = '5';
  document.getElementById('bufferedColorInput').value = '#ffffff';
  document.getElementById('searchRadiusInput').value = '24';
  document.getElementById('searchBorderInput').value = '#2a2a2a';
  
  // Apply dark theme if not already applied
  document.body.classList.remove('light-theme', 'blue-theme', 'green-theme');
  
  showToast('All customizations reset to defaults');
}

// -------- KEYBOARD SHORTCUTS
document.addEventListener('keydown', (e) => {
  let activeType = null;
  let activeVideo = null;
  
  if (document.getElementById('playlistPlayerPage').style.display !== 'none' && playerState.playlist.hasPlayed) {
    activeType = 'playlist';
    activeVideo = playerState.playlist.video;
  } else if (document.getElementById('networkStreamPage').style.display !== 'none' && document.getElementById('directPlayer').style.display !== 'none') {
    activeType = 'direct';
    activeVideo = playerState.direct.video;
  }
  
  if (!activeType || !activeVideo) return;
  
  switch(e.key) {
    case ' ':
      e.preventDefault();
      togglePlayPause(activeType);
      break;
    case 'f':
    case 'F':
      if (!document.body.classList.contains('fullscreen-mode')) {
        toggleFullscreen(activeType);
      }
      break;
    case 'p':
    case 'P':
      // PiP only works in portrait mode
      if (!document.body.classList.contains('fullscreen-mode')) {
        togglePiP(activeType);
      }
      break;
    case 'ArrowLeft':
      activeVideo.currentTime -= 10;
      showToast(`-10s`, 1000);
      break;
    case 'ArrowRight':
      activeVideo.currentTime += 10;
      showToast(`+10s`, 1000);
      break;
    case 'm':
    case 'M':
      toggleMute(activeType);
      break;
    case 'Escape':
      if (document.getElementById('editModal').style.display === 'flex') {
        closeEditModal();
      } else if (document.getElementById('settingsModal').style.display === 'flex') {
        closeSettingsModal();
      } else if (document.body.classList.contains('fullscreen-mode')) {
        rotateScreen();
      }
      break;
  }
});

// -------- CLICK OUTSIDE HANDLERS
document.addEventListener('click', (e) => {
  // Close quality menus when clicking outside
  const qualityMenus = ['playlistQualityMenu', 'directQualityMenu'];
  qualityMenus.forEach(menuId => {
    const menu = document.getElementById(menuId);
    if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !e.target.closest('.control-button')) {
      menu.style.display = 'none';
    }
  });
  
  // Close FAB menu when clicking outside
  const fabMenu = document.getElementById('fabMenu');
  const fab = e.target.closest('.fab');
  if (fabMenu && fabMenu.style.display === 'flex' && !fabMenu.contains(e.target) && !fab) {
    fabMenu.style.display = 'none';
  }
  
  // Close modals when clicking outside
  const modals = ['editModal', 'settingsModal'];
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (e.target === modal) {
      if (modalId === 'editModal') closeEditModal();
      if (modalId === 'settingsModal') closeSettingsModal();
    }
  });
});

// -------- DRAG & DROP SUPPORT
document.addEventListener('DOMContentLoaded', () => {
  const dropZone = document.getElementById('playlistPage');
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });
  
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
  });
  
  function highlight(e) {
    dropZone.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
  }
  
  function unhighlight(e) {
    dropZone.style.backgroundColor = '';
  }
  
  dropZone.addEventListener('drop', handleDrop, false);
  
  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length) {
      handleFiles(files);
    }
  }
  
  function handleFiles(files) {
    [...files].forEach(uploadFile);
  }
  
  function uploadFile(file) {
    if (!file.name.match(/\.(m3u|m3u8)$/i)) {
      showToast("Please upload a valid M3U/M3U8 file");
      return;
    }
    
    const reader = new FileReader();
    reader.onload = () => {
      const name = prompt("Playlist name:", file.name.replace(/\.[^/.]+$/, ""));
      if (!name) return;
      
      playlists.push({
        name: name,
        data: reader.result,
        type: "file"
      });
      
      savePlaylists();
      renderPlaylists();
      showToast("Playlist added successfully!");
    };
    reader.readAsText(file);
  }
  
  // Initialize
  initializePlayers();
  renderPlaylists();
  
  // Load saved customizations
  const savedTheme = localStorage.getItem('theme') || 'dark';
  changeTheme(savedTheme);
  
  const savedFontSize = localStorage.getItem('fontSize') || '16px';
  changeFontSize(savedFontSize);
  
  const savedProgressColor = localStorage.getItem('progressColor') || '#ff0000';
  changeProgressColor(savedProgressColor);
  
  const savedAccentColor = localStorage.getItem('accentColor') || '#e74c3c';
  changeAccentColor(savedAccentColor);
  
  const savedBgImage = localStorage.getItem('bgImage') || '';
  changeBgImage(savedBgImage);
  
  const savedCardRadius = localStorage.getItem('cardRadius') || '12';
  changeCardRadius(savedCardRadius);
  
    const savedPlayerRadius = localStorage.getItem('playerRadius') || '0';
  changePlayerRadius(savedPlayerRadius);
  
  const savedControlSize = localStorage.getItem('controlSize') || '20';
  changeControlSize(savedControlSize);
  
  const savedGridColumns = localStorage.getItem('gridColumns') || 'minmax(180px,1fr)';
  changeGridColumns(savedGridColumns);
  
  const savedPlayerAspect = localStorage.getItem('playerAspect') || '16/9';
  changePlayerAspect(savedPlayerAspect);
  
  const savedProgressHeight = localStorage.getItem('progressHeight') || '5';
  changeProgressHeight(savedProgressHeight);
  
  const savedBufferedColor = localStorage.getItem('bufferedColor') || '#ffffff';
  changeBufferedColor(savedBufferedColor);
  
  const savedSearchRadius = localStorage.getItem('searchRadius') || '24';
  changeSearchRadius(savedSearchRadius);
  
  const savedSearchBorder = localStorage.getItem('searchBorder') || '#2a2a2a';
  changeSearchBorder(savedSearchBorder);
  
  // Homepage Categories
  renderCategories();
  
  // Always start on homepage
  navigateTo('homepage');
  
  // Handle browser refresh
  window.addEventListener('beforeunload', () => {
    // Save current page to localStorage
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id || 'homepage';
    localStorage.setItem('currentPage', currentPage);
  });
});

// -------- HOMEPAGE CATEGORIES
const categories = [
  { name:"Sports", icon:"https://upload.wikimedia.org/wikipedia/commons/3/3f/Sport_balls.svg", url:"https://iptv-org.github.io/iptv/categories/sports.m3u" },
  { name:"Bangladesh", icon:"https://upload.wikimedia.org/wikipedia/commons/f/f9/Flag_of_Bangladesh.svg", url:"https://iptv-org.github.io/iptv/countries/bd.m3u" },
  { name:"Kolkata", icon:"https://cdn-icons-png.flaticon.com/512/197/197610.png", url:"https://iptv-org.github.io/iptv/subdivisions/in-wb.m3u" },
  { name:"India", icon:"https://upload.wikimedia.org/wikipedia/en/4/41/Flag_of_India.svg", url:"https://iptv-org.github.io/iptv/countries/in.m3u" },
  { name:"Pakistan", icon:"https://upload.wikimedia.org/wikipedia/commons/3/32/Flag_of_Pakistan.svg", url:"https://iptv-org.github.io/iptv/countries/pk.m3u" },
  { name:"News", icon:"https://cdn-icons-png.flaticon.com/512/2965/2965879.png", url:"https://iptv-org.github.io/iptv/categories/news.m3u" },
  { name:"Movies", icon:"https://cdn-icons-png.flaticon.com/512/684/684908.png", url:"https://iptv-org.github.io/iptv/categories/movies.m3u" },
  { name:"Music", icon:"https://cdn-icons-png.flaticon.com/512/727/727245.png", url:"https://iptv-org.github.io/iptv/categories/music.m3u" },
  { name:"Kids", icon:"https://cdn-icons-png.flaticon.com/512/1076/1076335.png", url:"https://iptv-org.github.io/iptv/categories/kids.m3u" }
];

function renderCategories() {
  document.getElementById("categoryGrid").innerHTML =
    categories.map(c=>`
      <div class="category-card" onclick="loadCategoryPlaylist('${c.url}','${c.name}')">
        <img src="${c.icon}" alt="${c.name}"/><span>${c.name}</span>
      </div>`).join('');
}

// FIXED CATEGORY LOADING FUNCTION
async function loadCategoryPlaylist(url, name) {
  showLoading(true);
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Failed to fetch playlist: ${response.status} ${response.statusText}`);
    }
    
    const text = await response.text();
    channels = parseM3U(text);
    
    if (channels.length === 0) {
      throw new Error('No channels found in playlist');
    }
    
    // Reset player state when loading new playlist
    playerState.playlist.hasPlayed = false;
    document.getElementById('playlistPlayer').style.display = 'none';
    
    renderChannels(channels);
    navigateTo('playlistPlayerPage');
    showToast(`Loaded ${channels.length} ${name} channels`);
  } catch (error) {
    console.error('Category playlist loading error:', error);
    showToast("Failed to load playlist: " + error.message);
  }
  showLoading(false);
}
</script>
</body>
</html>